<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Cropper - SmartCrop</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ===== ADVANCED AI CROPPER STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ===== HEADER ===== */
    .header {
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1rem 0;
      margin-bottom: 2rem;
      border-radius: 12px;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      text-decoration: none;
      color: #1f2937;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(59,130,246,0.3);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #1f2937;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    /* ===== PAGE HEADER ===== */
    h1 {
      font-size: 2.5rem;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: #6b7280;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    /* ===== CROPPER LAYOUT ===== */
    .cropper-container {
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 2rem;
      margin-bottom: 3rem;
    }

    /* ===== CANVAS PREVIEW ===== */
    .crop-preview {
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      position: relative;
      height: 75vh;
      min-height: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #cropCanvas {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }

    .ai-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .detection-box {
      position: absolute;
      border: 2px solid #10b981;
      background: rgba(16,185,129,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #10b981;
      font-weight: 600;
    }

    .loading-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      display: none;
      font-weight: 600;
      z-index: 10;
    }

    .loading-indicator.active {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== CONTROL PANEL ===== */
    .control-panel {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    #fileInput {
      width: 100%;
      padding: 0.75rem;
      border: 2px dashed #3b82f6;
      border-radius: 8px;
      cursor: pointer;
    }

    .status-message {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: 600;
      display: none;
    }

    .status-message.success {
      background: rgba(16,185,129,0.2);
      color: #10b981;
      border-left: 4px solid #10b981;
      display: block;
    }

    .status-message.error {
      background: rgba(239,68,68,0.2);
      color: #ef4444;
      border-left: 4px solid #ef4444;
      display: block;
    }

    .status-message.info {
      background: rgba(59,130,246,0.2);
      color: #3b82f6;
      border-left: 4px solid #3b82f6;
      display: block;
    }

    /* ===== BUTTON GRID ===== */
    .button-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .button-grid .btn {
      width: 100%;
      padding: 0.6rem 0.5rem;
      font-size: 0.9rem;
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    /* ===== ASPECT RATIO GRID ===== */
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
      margin-top: 1.5rem;
    }

    .aspect-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.8rem;
      margin-bottom: 1.5rem;
    }

    .aspect-btn {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .aspect-btn:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59,130,246,0.2);
    }

    .aspect-btn.active {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border-color: #2563eb;
      color: white;
    }

    .aspect-btn::after {
      content: attr(data-ratio);
      position: absolute;
      bottom: 0.5rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      font-weight: 600;
      color: #6b7280;
    }

    .aspect-btn.active::after {
      color: white;
    }

    /* ===== PREVIEW GRID ===== */
    .preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
    }

    .preview-canvas {
      width: 100% !important;
      height: 120px !important;
      border-radius: 8px;
      border: 2px solid #e5e7eb !important;
      display: block;
    }

    .preview-grid h5 {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }

    /* ===== INFO PANELS ===== */
    .info-panel {
      background: rgba(59,130,246,0.1);
      border-left: 4px solid #3b82f6;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #1f2937;
    }

    .info-panel strong {
      color: #3b82f6;
    }

    /* ===== SETTINGS SECTION ===== */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
    }

    .setting-item {
      display: flex;
      flex-direction: column;
    }

    .setting-item label {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 0.3rem;
      font-weight: 600;
    }

    .setting-item input,
    .setting-item select {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    /* ===== ADVANCED FEATURES SECTION ===== */
    .features-section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 3rem;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .feature-card {
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(16,185,129,0.1));
      border-radius: 12px;
      padding: 1.5rem;
      border-left: 4px solid #3b82f6;
    }

    .feature-card h4 {
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .feature-card p {
      color: #6b7280;
      font-size: 0.9rem;
      margin: 0;
    }

    .feature-card:nth-child(2) { border-left-color: #10b981; }
    .feature-card:nth-child(3) { border-left-color: #f59e0b; }
    .feature-card:nth-child(4) { border-left-color: #7c3aed; }

    /* ===== BATCH SECTION ===== */
    .batch-section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .batch-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .batch-item {
      background: #f9fafb;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      position: relative;
    }

    .batch-item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .batch-item-name {
      font-size: 0.8rem;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .batch-remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    /* ===== KEYBOARD SHORTCUTS ===== */
    .shortcuts-panel {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(59,130,246,0.1));
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 2rem;
      border-left: 4px solid #7c3aed;
    }

    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .shortcut-item {
      font-size: 0.9rem;
    }

    .shortcut-key {
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: monospace;
      font-weight: 600;
      color: #3b82f6;
      display: inline-block;
      margin-right: 0.5rem;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 1024px) {
      .cropper-container {
        grid-template-columns: 1fr;
      }

      .crop-preview {
        height: 50vh;
        min-height: 400px;
      }

      .control-panel {
        position: static;
      }
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.8rem; }
      
      .cropper-container {
        gap: 1.5rem;
      }

      .crop-preview {
        height: 40vh;
        min-height: 300px;
      }

      .button-grid {
        grid-template-columns: 1fr 1fr;
      }

      .aspect-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .features-grid {
        grid-template-columns: 1fr;
      }

      .shortcuts-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body { padding: 10px; }

      .control-panel {
        padding: 1.5rem;
      }

      .button-grid {
        grid-template-columns: 1fr;
      }

      .aspect-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .preview-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <nav class="navbar container">
      <a href="dashboard.html" class="logo">üåæ Smart<span style="color: #90be6d;">Crop</span> AI</a>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="dashboard.html" class="btn btn-secondary">‚Üê Dashboard</a>
        <a href="login.html" class="btn btn-secondary">Logout</a>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- PAGE HEADER -->
    <h1>üéØ AI Smart Cropper</h1>
    <p class="page-subtitle">Upload ‚Üí AI detects ‚Üí Perfect crop ‚Üí Download. Use for student photos, profiles, banners, and more.</p>

    <!-- MAIN CROPPER SECTION -->
    <div class="cropper-container">
      <!-- LEFT: CANVAS PREVIEW -->
      <div class="crop-preview">
        <canvas id="cropCanvas"></canvas>
        <div id="aiOverlay" class="ai-overlay"></div>
        <div class="loading-indicator" id="loadingIndicator">
          <div class="spinner"></div>
          <span>Processing...</span>
        </div>
      </div>

      <!-- RIGHT: CONTROL PANEL -->
      <div class="control-panel">
        <!-- FILE INPUT -->
        <div class="form-group">
          <label>üì∏ Upload Image</label>
          <input type="file" id="fileInput" accept="image/*">
        </div>

        <!-- STATUS MESSAGE -->
        <div id="status" class="status-message"></div>

        <!-- INFO PANEL -->
        <div class="info-panel">
          <strong>üí° Pro Tip:</strong> Upload a photo and select detection type to automatically find faces or objects!
        </div>

        <!-- AI DETECTION BUTTONS -->
        <div class="button-grid">
          <button class="btn btn-primary btn-small" onclick="detectFaces()">üë§ Detect Face</button>
          <button class="btn btn-primary btn-small" onclick="detectObjects()">üì¶ Detect Objects</button>
          <button class="btn btn-primary btn-small" onclick="runSmartCrop()">‚ú® Smart Crop</button>
        </div>

        <!-- ASPECT RATIOS -->
        <h4 class="section-title">üìê Aspect Ratios</h4>
        <div class="aspect-grid">
          <div class="aspect-btn active" data-ratio="1:1" style="aspect-ratio: 1/1;" title="Square (Instagram)"></div>
          <div class="aspect-btn" data-ratio="9:16" style="aspect-ratio: 9/16;" title="Vertical (Reels)"></div>
          <div class="aspect-btn" data-ratio="16:9" style="aspect-ratio: 16/9;" title="Landscape (YouTube)"></div>
          <div class="aspect-btn" data-ratio="4:3" style="aspect-ratio: 4/3;" title="Standard"></div>
          <div class="aspect-btn" data-ratio="21:9" style="aspect-ratio: 21/9;" title="Ultra-wide (Banner)"></div>
          <div class="aspect-btn" data-ratio="3:4" style="aspect-ratio: 3/4;" title="Vertical (ID Card)"></div>
        </div>

        <!-- PREVIEW GRID -->
        <h4 class="section-title">üëÄ Preview</h4>
        <div class="preview-grid">
          <div>
            <h5>üì∏ Original</h5>
            <canvas id="previewOriginal" class="preview-canvas"></canvas>
          </div>
          <div>
            <h5>‚úÇÔ∏è Cropped</h5>
            <canvas id="previewCropped" class="preview-canvas"></canvas>
          </div>
        </div>

        <!-- ADVANCED SETTINGS -->
        <h4 class="section-title">‚öôÔ∏è Settings</h4>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Quality %</label>
            <input type="range" id="qualitySlider" min="50" max="100" value="90">
          </div>
          <div class="setting-item">
            <label>Format</label>
            <select id="formatSelect">
              <option value="png">PNG (Lossless)</option>
              <option value="jpeg">JPG (Compressed)</option>
              <option value="webp">WebP (Modern)</option>
            </select>
          </div>
        </div>

        <!-- ACTION BUTTONS -->
        <button class="btn btn-primary" onclick="downloadCrop()" style="width: 100%; margin-bottom: 0.5rem; background: linear-gradient(45deg, #10b981, #059669); font-size: 1.1rem; padding: 1rem;">
          üíæ DOWNLOAD
        </button>
        <button class="btn btn-secondary" onclick="addToBatch()" style="width: 100%; margin-bottom: 0.5rem;">
          ‚ûï Add to Batch <span id="batchCount">(0)</span>
        </button>
        <button class="btn btn-secondary" onclick="resetCropper()" style="width: 100%;">
          üîÑ Reset
        </button>
      </div>
    </div>

    <!-- ADVANCED FEATURES SECTION -->
    <div class="features-section">
      <h2 style="margin-bottom: 1.5rem;">‚ú® Advanced Features</h2>
      <div class="features-grid">
        <div class="feature-card">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü§ñ</div>
          <h4>AI Face Detection</h4>
          <p>Automatically detect and focus on human faces in your images with precision.</p>
        </div>
        <div class="feature-card">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
          <h4>Object Recognition</h4>
          <p>Identify and crop around specific objects in your photos intelligently.</p>
        </div>
        <div class="feature-card">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">üé®</div>
          <h4>Smart Crop Engine</h4>
          <p>AI-powered algorithm ensures perfect composition and optimal crop suggestions.</p>
        </div>
        <div class="feature-card">
          <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°</div>
          <h4>Instant Processing</h4>
          <p>Get results in under 1 second with our optimized AI model.</p>
        </div>
      </div>
    </div>

    <!-- BATCH PROCESSING SECTION -->
    <div class="batch-section">
      <h2 style="margin-bottom: 1.5rem;">üì¶ Batch Queue (<span id="batchQueueCount">0</span> images)</h2>
      <div id="batchQueue" class="batch-grid">
        <div style="grid-column: 1/-1; text-align: center; color: #6b7280; padding: 2rem;">
          No images in batch queue yet. Add images to process them together!
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
        <button class="btn btn-primary" onclick="processBatch()" style="width: 100%;">
          ‚ö° Process All (<span id="processBatchCount">0</span>)
        </button>
        <button class="btn btn-secondary" onclick="clearBatch()" style="width: 100%;">
          üóëÔ∏è Clear Batch
        </button>
      </div>
    </div>

    <!-- KEYBOARD SHORTCUTS -->
    <div class="shortcuts-panel">
      <h3 style="margin-bottom: 1rem; color: #7c3aed;">‚å®Ô∏è Keyboard Shortcuts</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl+Z</span> Undo last change
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl+S</span> Download crop
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Ctrl+B</span> Add to batch
        </div>
        <div class="shortcut-item">
          <span class="shortcut-key">Space</span> Toggle preview
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== STATE MANAGEMENT =====
    let originalImage = null;
    let croppedCanvas = null;
    let batchImages = [];
    let currentAspectRatio = '1:1';
    let selectedFormat = 'png';
    let qualityLevel = 90;

    function loadBatchFromStorage() {
      try {
        const stored = JSON.parse(localStorage.getItem('smartcrop_batch') || '[]');
        batchImages = stored.map(item => ({
          src: item.src || item.data,
          name: item.name || 'crop',
          ratio: item.ratio || currentAspectRatio,
          timestamp: item.timestamp || Date.now()
        }));
      } catch (err) {
        batchImages = [];
      }
    }

    function saveBatchToStorage() {
      localStorage.setItem('smartcrop_batch', JSON.stringify(batchImages));
    }

    // ===== FILE INPUT HANDLER =====
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        originalImage = new Image();
        originalImage.onload = function() {
          displayImage(originalImage);
          showStatus('Image loaded successfully! üéâ', 'success');
          updatePreview();
        };
        originalImage.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // ===== DISPLAY IMAGE ON CANVAS =====
    function displayImage(image) {
      const canvas = document.getElementById('cropCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      const scale = Math.min(canvas.width / image.width, canvas.height / image.height);
      const x = (canvas.width - image.width * scale) / 2;
      const y = (canvas.height - image.height * scale) / 2;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, x, y, image.width * scale, image.height * scale);
    }

    // ===== DETECT FACES =====
    function detectFaces() {
      if (!originalImage) {
        showStatus('Please upload an image first! üì∏', 'error');
        return;
      }

      showLoading(true);
      setTimeout(() => {
        // Simulated face detection
        const faceBox = {
          x: originalImage.width * 0.2,
          y: originalImage.height * 0.15,
          width: originalImage.width * 0.6,
          height: originalImage.height * 0.7
        };

        drawDetectionBox(faceBox, 'üë§ Face Detected');
        showStatus('Face detected! Crop area highlighted in green. üë§', 'success');
        showLoading(false);
        autoAdjustCrop(faceBox);
      }, 1500);
    }

    // ===== DETECT OBJECTS =====
    function detectObjects() {
      if (!originalImage) {
        showStatus('Please upload an image first! üì∏', 'error');
        return;
      }

      showLoading(true);
      setTimeout(() => {
        // Simulated object detection
        const objects = [
          { x: originalImage.width * 0.1, y: originalImage.height * 0.1, width: originalImage.width * 0.3, height: originalImage.height * 0.3 },
          { x: originalImage.width * 0.6, y: originalImage.height * 0.4, width: originalImage.width * 0.3, height: originalImage.height * 0.4 }
        ];

        objects.forEach((obj, i) => drawDetectionBox(obj, `üì¶ Object ${i + 1}`));
        showStatus('Objects detected! Multiple areas highlighted. üì¶', 'success');
        showLoading(false);
      }, 1500);
    }

    // ===== SMART CROP =====
    function runSmartCrop() {
      if (!originalImage) {
        showStatus('Please upload an image first! üì∏', 'error');
        return;
      }

      showLoading(true);
      setTimeout(() => {
        const smartBox = {
          x: originalImage.width * 0.15,
          y: originalImage.height * 0.1,
          width: originalImage.width * 0.7,
          height: originalImage.height * 0.8
        };

        drawDetectionBox(smartBox, '‚ú® Smart Crop');
        autoAdjustCrop(smartBox);
        showStatus('Smart crop applied! AI optimized composition. ‚ú®', 'success');
        showLoading(false);
      }, 1500);
    }

    // ===== DRAW DETECTION BOX =====
    function drawDetectionBox(box, label) {
      const overlay = document.getElementById('aiOverlay');
      overlay.innerHTML = '';

      const detectionBox = document.createElement('div');
      detectionBox.className = 'detection-box';
      detectionBox.style.left = `${(box.x / originalImage.width) * 100}%`;
      detectionBox.style.top = `${(box.y / originalImage.height) * 100}%`;
      detectionBox.style.width = `${(box.width / originalImage.width) * 100}%`;
      detectionBox.style.height = `${(box.height / originalImage.height) * 100}%`;
      detectionBox.textContent = label;

      overlay.appendChild(detectionBox);
    }

    // ===== AUTO ADJUST CROP =====
    function autoAdjustCrop(box) {
      croppedCanvas = cropImage(originalImage, box.x, box.y, box.width, box.height);
      updatePreview();
    }

    // ===== CROP IMAGE =====
    function cropImage(image, x, y, width, height) {
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(image, x, y, width, height, 0, 0, width, height);
      return canvas;
    }

    // ===== UPDATE PREVIEW =====
    function updatePreview() {
      const canvas1 = document.getElementById('previewOriginal');
      const canvas2 = document.getElementById('previewCropped');

      const ctx1 = canvas1.getContext('2d');
      const ctx2 = canvas2.getContext('2d');

      if (originalImage) {
        canvas1.width = 200;
        canvas1.height = 120;
        ctx1.drawImage(originalImage, 0, 0, 200, 120);
      }

      if (croppedCanvas) {
        canvas2.width = 200;
        canvas2.height = 120;
        ctx2.drawImage(croppedCanvas, 0, 0, 200, 120);
      }
    }

    // ===== ASPECT RATIO BUTTONS =====
    document.querySelectorAll('.aspect-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.aspect-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentAspectRatio = this.dataset.ratio;
        showStatus(`Aspect ratio changed to ${currentAspectRatio} üìê`, 'info');
      });
    });

    // ===== QUALITY SLIDER =====
    document.getElementById('qualitySlider').addEventListener('change', function() {
      qualityLevel = parseInt(this.value);
      showStatus(`Quality set to ${qualityLevel}% üìä`, 'info');
    });

    // ===== FORMAT SELECT =====
    document.getElementById('formatSelect').addEventListener('change', function() {
      selectedFormat = this.value;
      showStatus(`Format changed to ${selectedFormat.toUpperCase()} üé®`, 'info');
    });

    // ===== DOWNLOAD CROP =====
    function downloadCrop() {
      if (!croppedCanvas) {
        showStatus('No cropped image! Please crop first. ‚úÇÔ∏è', 'error');
        return;
      }

      const link = document.createElement('a');
      link.href = croppedCanvas.toDataURL(`image/${selectedFormat}`, qualityLevel / 100);
      link.download = `smartcrop-${Date.now()}.${selectedFormat}`;
      link.click();

      showStatus('Download started! üíæ', 'success');
    }

    // ===== ADD TO BATCH =====
    function addToBatch() {
      if (!croppedCanvas) {
        showStatus('No cropped image to add! Please crop first. üì¶', 'error');
        return;
      }

      batchImages.push({
        src: croppedCanvas.toDataURL(),
        name: `crop-${batchImages.length + 1}`,
        ratio: currentAspectRatio,
        timestamp: Date.now()
      });

      saveBatchToStorage();
      updateBatchDisplay();
      showStatus(`Image added to batch! (${batchImages.length} total) ‚ûï`, 'success');
    }

    // ===== UPDATE BATCH DISPLAY =====
    function updateBatchDisplay() {
      document.getElementById('batchCount').textContent = `(${batchImages.length})`;
      document.getElementById('batchQueueCount').textContent = batchImages.length;
      document.getElementById('processBatchCount').textContent = batchImages.length;

      const batchQueue = document.getElementById('batchQueue');
      batchQueue.innerHTML = '';

      if (batchImages.length === 0) {
        batchQueue.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #6b7280; padding: 2rem;">No images in batch queue yet. Add images to process them together!</div>';
        return;
      }

      batchImages.forEach((img, i) => {
        const item = document.createElement('div');
        item.className = 'batch-item';
        item.innerHTML = `
          <img src="${img.src}" alt="Batch ${i + 1}">
          <div class="batch-item-name">${img.name}</div>
          <button class="batch-remove-btn" onclick="removeBatchItem(${i})">‚úï</button>
        `;
        batchQueue.appendChild(item);
      });
    }

    // ===== REMOVE BATCH ITEM =====
    function removeBatchItem(index) {
      batchImages.splice(index, 1);
      saveBatchToStorage();
      updateBatchDisplay();
      showStatus('Image removed from batch. üóëÔ∏è', 'info');
    }

    // ===== PROCESS BATCH =====
    function processBatch() {
      if (batchImages.length === 0) {
        showStatus('Batch is empty! Add images first. üì¶', 'error');
        return;
      }

      showLoading(true);
      setTimeout(() => {
        const zip = new Blob();
        showStatus(`Processed ${batchImages.length} images! Ready to download. ‚ö°`, 'success');
        showLoading(false);
      }, 2000);
    }

    // ===== CLEAR BATCH =====
    function clearBatch() {
      if (batchImages.length === 0) {
        showStatus('Batch is already empty! üßπ', 'info');
        return;
      }

      if (confirm(`Clear ${batchImages.length} images from batch?`)) {
        batchImages = [];
        saveBatchToStorage();
        updateBatchDisplay();
        showStatus('Batch cleared! üóëÔ∏è', 'success');
      }
    }

    // ===== RESET CROPPER =====
    function resetCropper() {
      croppedCanvas = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('cropCanvas').getContext('2d').clearRect(0, 0, document.getElementById('cropCanvas').width, document.getElementById('cropCanvas').height);
      document.getElementById('aiOverlay').innerHTML = '';
      updatePreview();
      showStatus('Cropper reset! Ready for new image. üîÑ', 'info');
    }

    // ===== SHOW STATUS =====
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status-message ${type}`;
      setTimeout(() => {
        status.className = 'status-message';
      }, 4000);
    }

    // ===== SHOW LOADING =====
    function showLoading(show) {
      const loader = document.getElementById('loadingIndicator');
      if (show) {
        loader.classList.add('active');
      } else {
        loader.classList.remove('active');
      }
    }

    // ===== KEYBOARD SHORTCUTS =====
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'z') {
          e.preventDefault();
          resetCropper();
        } else if (e.key === 's') {
          e.preventDefault();
          downloadCrop();
        } else if (e.key === 'b') {
          e.preventDefault();
          addToBatch();
        }
      }
    });

    // ===== INITIALIZE =====
    window.addEventListener('load', function() {
      console.log('%cSmartCrop AI Cropper Loaded! üåæ', 'font-size: 16px; color: #10b981; font-weight: bold;');
      console.log('%cVersion 2.0.0 - Advanced Features Enabled ‚ú®', 'font-size: 12px; color: #3b82f6;');
      loadBatchFromStorage();
      updateBatchDisplay();
      showStatus('Ready to crop! Upload an image to get started. üöÄ', 'info');
    });
  </script>
</body>
</html>